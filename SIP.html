<html>
    <head>
        <link rel="stylesheet" href="style1.css">
        <title>Технология SIP</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    </head>
    <body>
        <div class="scroll-indicator"></div>
        <h1 class="animated-title">Что такое SIP?</h1>
        <p>SIP – это протокол передачи голосовых данных, построенный на принципах IP-телефонии. Простыми словами – технология для осуществления звонков через интернет.</p>
            <p>Вообще, в повседневной жизни принято отождествлять термины IP-, VoIP- и SIP-телефония, подразумевая под ними голосовую связь через интернет. Но на самом деле между ними есть отличия:</p>
         <p>   1. IP (или Internet Protocol) – это межсетевой протокол, по которому сетевые устройства соединяются в общую сеть (каждое устройство, подключенное к сети (компьютер, телефон и пр.) имеет свой IP-адрес);</p>
         <p>   2. VoIP (или Voice over IP) – это технология передачи аудиоданных по межсетевому протоколу;</p>
         <p>   3. SIP (или Session Initiation Protocol) – это конкретный протокол для передачи аудиоданных.</p>
           <p> Таким образом, SIP – это более узкое понятие, чем IP-телефония. Это конкретный канал для передачи сообщений от одного пользователя к другому. Он работает по следующему принципу:</p>
         <p> 1. Абонент 1 создает голосовое сообщение. Система записывает его, а специальные кодеки сжимают (это необходимо для снижения нагрузки на сеть). Таким образом, происходит преобразование аналогового («голосового») сигнала в цифровой; </p>
         <p> 2. Устройство Абонента 1 передает сигнал на устройство Абонента 2;</p>
         <p> 3. Между устройствами происходит установка соединения. Сначала связь устанавливается по IP-адресам, а затем – по SIP-протоколу;</p>
         <p>4. На устройстве Абонента 2 происходит обратное преобразование сигнала – из цифрового в аналоговый. Абонент 2 слышит голосовое сообщение.</p>
            <p>Все это занимает считанные доли секунды, поэтому для обоих абонентов все процессы записи, сжатия, передачи и расшифровки незаметны. Создается впечатление беседы в реальном времени, как, например, по обычному телефону.</p>
            <p>В качестве оборудования для звонков по SIP-протоколу используются софтфоны (специальные программы и приложения для компьютеров и мобильных устройств), SIP-телефоны (обычные телефонные аппараты с поддержкой SIP-протокола) и классические аналоговые телефоны аппараты, подключенные к IP-телефонии по VoIP-шлюзу.</p>
            <p>Также у пользователя должна быть подключена сама IP-телефония. Эту услугу оказывают операторы связи (например, МТТ <a href="https://www.mtt.ru/" target="_blank">Ссылка на сайт оператора здесь</a>). Вы можете приобрести виртуальный номер, виртуальную АТС (или использовать собственную мини-АТС на базе, например, Asterisk) и другие дополнительные услуги (запись звонков, голосовое меню и т.д.).</p>
            <h1>Схема общения по протоколу SIP</h1>
    <p>Первым делом чтобы получить возможность получать и совершать вызовы необходимо зарегистрироваться в сети. Для этого достаточно выполнить запрос «REGISTER»:</p>
    <img src="C:\Users\stud\Desktop\Web\photo8.jpg" width="600">
    <p>После успешной регистрации набор запросов/ответов выглядит так:</p>
    <img src="C:\Users\stud\Desktop\Web\photo9.jpg" width="600">
    <p>Теперь разберем каждый запрос отдельно.</p>
    <p>Первым делом устройство, совершающее вызов, отправляет запрос «INVITE» вызываемому абоненту для того, чтобы пригласить его начать сеанс связи.</p>
    <p>Как только вызывающий абонент отправит «INVITE», сразу же запускается таймер ожидания ответных сообщений, чтобы понять, а прошел ли запрос. И ждет он простейший ответ с той стороны в виде сообщения «100 Trying», который остановит таймер.</p>
    <p>Далее сторона Б отправляет еще один запрос «180 Ringing», который означает что абонент Б свободен и готов ответить на звонок. Но абонент может быть и занят. В таком случае отправляется другой запрос, о котором мы поговорим чуть позже.</p>
    <p>Что ж, звонок мы отправили, пора бы и пообщаться!</p>
    <p>Как только абонент Б берет трубку, он отправляет запрос «200 ОК».</p>
    <p>Как и абоненту А, абоненту Б тоже необходимо узнать о том, что его ОК дошел и сеанс можно продолжать. Для этого абонент А отправляет сообщение «ACK».</p>
    <p>И наконец свершилось! Можно и пообщаться! Да, действительно, первый этап пройден, обе стороны узнали друг о друге, договорились о всех нюансах взаимодействия и начинают второй этап - обмен мультимедиапотоком. Как правило, информация в этом случае передается по протоколу RTP (Realtime Transfer Protocol).</p>
    <p>Третьим этапом можно выделить завершение общения. </p>
    <p>Абонент, инициирующий завершение сеанса, отправляет сообщение «BYE». Второй абонент, получив это сообщение, может при необходимости воспроизвести звуковой сигнал, соответствующий занятой линии, или просто завершить сеанс, но так или иначе он обязан отправить инициатору сообщение «200 ОК», чтобы сигнализировать о том, что сообщение было доставлено и подтвердить согласие на освобождение всех задействованных ресурсов.</p>
    <p>Так мы обработали основной flow ip-телефонии. Этот flow необходимо расширять и другими типами сообщений для поддержания корректной работы, но для старта достаточно и этого.</p>
    <h1>Реализация</h1>
    <h1>SIP</h1>
    <p>Прежде чем начать голосовую передачу, нужно договориться, то есть реализовать протокол SIP. </p>
    <p>SIP очень похож на протокол HTTP, используемый для Web приложений, или на SMTP (обмен почтовыми сообщениями). Сообщения состоят из заголовков и тела сообщения. SIP - это протокол, использующий текстовые сообщения, в которых используется кодировка UTF-8. SIP использует номер порта 5060, как для коммуникации по протоколу UDP, так и для TCP.</p>
    <p>Подробнее почитать о протоколе можно <a href="https://datatracker.ietf.org/wg/sip/about/" target="_blank">здесь.</a></p>
    <p>На старте проекта мы не обладали сторонним framework, реализующим протокол SIP. Сначала мы проанализировали формат всех запросов и ответов на примере использования open source softphone - <a href="https://github.com/BelledonneCommunications/linphone-android" target="_blank">Linphone.</a> С использованием этой утилиты мы получили представление о работе и формате протокола SIP. Например, вот так выглядит запрос «REGISTER»:</p>
   <div class="box">
    <div class="font"> 
        <p>REGISTER sip:1.1.1.1 SIP/2.0</p>
        <p>Via: SIP/2.0/UDP 1.1.1.1:5555;branch=xxxxx;rport</p>
        <p>From: ;tag=xxxxx</p>
        <p>o: sip:yyyy@1.1.1.1</p>
        <p>CSeq: 20 REGISTER</p>
        <p>Call-ID: xxxxx</p>
        <p>Max-Forwards: 70</p>
        <p>Supported: replaces, outbound</p>
        <p>Accept: xxxxx</p>
        <p>Contact: ;</p>
        <p>Expires: 3600</p>
        <p>User-Agent: Unknown (belle-sip/1.5.0)</p>
    </div>
    </div>
    <p>В качестве канала передачи запросов протокола SIP мы использовали <a href="https://github.com/square/okhttp" target="_blank">framework OkHttp.</a>
    Достаточно удобный в применении. Конечно, WebSocket-соединение мы использовали с URI-схемой «wss» (шифрованное соединение) с SSL-pinning (внедрение SSL сертификата, который используется на сервере, в коде мобильного приложения для проверки подлинности сервера).</p>
   <h1>RTP</h1>
    <p>Вот теперь можно организовывать передачу медиапотока, то есть реализовать протокол RTP. При использовании протокола RTP открываются два порта для коммуникации. Один - для передачи потока медиаданных (четный номер порта), и второй - для передачи данных сигнализации (обратная связь для QoS и контроль медиапотока) - RTCP. Значения номеров портов жестко не привязаны. С форматом можно <a href="https://habr.com/ru/companies/Voximplant/articles/354502/" target="_blank">познакомиться здесь.</a>
        С реализацией протокола RTP нам повезло больше - WebRTC. Это проект с открытым исходным кодом, предназначенный для организации передачи потоковых данных между браузерами или другими поддерживающими его приложениями по технологии точка-точка.</p>
    <h1>NAT</h1>
    <p>Все бы хорошо, но мы столкнулись с проблемами прохождения NAT. А проблемы заключаются в том что, если один из участников, участвующий в этом сеансе, использует IP-адрес из приватной сети, тогда поток от абонента, находящегося в публичной сети в сторону NAT сервера, не сможет достичь абонента, находящегося во внутренней сети.</p>
    <p>Для их решения мы использовали протоколы:</p>
<ul>
    <li>TURN (Traversal Using Relay NAT) - протокол, который позволяет узлу за NAT (или брандмауэром) получать входящие данные через TCP или UDP соединения (для общения с нашим TURN-сервером);</li>
    <li>ICE (Interactive Connectivity Establishment) - протокол, который обеспечивает прохождение трафика через различные устройства NAT (из коробки WebRTC).</li>
</ul>
<p>Таким образом, донастроив нашу работу с WebRTC на использование этих протоколов, мы получили полноценную передачу голосового потока посредством сети Интернет.</p>
<p>На этом у меня всё. Спасибо за внимание!</p> 
<button> <a href="html.html" style="text-decoration: none;">Вернуться на главную</a></button>
<script src="SIP.js"></script>
    </body>
</html>